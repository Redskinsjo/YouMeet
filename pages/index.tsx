/* eslint-disable react-hooks/rules-of-hooks */
import type { NextPage } from 'next'
import Head from 'next/head'
import { useRouter } from 'next/router'
import { useSelector, useDispatch } from 'react-redux'
import { useEffect, useState } from 'react'
import { ClipLoader } from 'react-spinners'
import { useQuery } from '@apollo/client'
import { useSession } from 'next-auth/react'

import { withProtected } from '@/components/route-protection'
import { RootState } from '@/redux/store'
import Header from '@/components/header'
import { GetEmployees } from '@/apollo/queries'
import MapboxMap from '@/components/mapbox-map'
import EmployeesList from '@/components/employees-list'
import Footer from '@/components/footer'
import Search from '@/components/search'
import {
  setEmployees,
  fetchingEmployees,
} from '@/redux/features/employeesSlice'

const Home: NextPage = () => {
  const username = useSelector((state: RootState) => state.user.username)
  const router = useRouter()
  const [authenticated, setAuthenticated] = useState(username ? true : false)
  const { data, refetch } = useQuery(GetEmployees, {
    variables: { filter: '', sort: 2 },
  })
  const { data: session } = useSession()
  const dispatch = useDispatch()

  // local state
  const [search, setSearch] = useState('')
  const handleChangeSearch = (e: any) => setSearch(e.target.value)
  const [criteria, setCriteria] = useState(2)
  const handleChangeCriteria = (e: any) => setCriteria(e.target.value)
  console.log(criteria)
  useEffect(() => {
    const fetchData = async () => {
      dispatch(fetchingEmployees())
      const empl = await refetch({
        filter: search,
        sort: criteria,
      })
      dispatch(setEmployees(empl.data.employees))
      // // simulate request timeout
      // const request = new Promise((resolve) => {
      //   // setLoading(true);
      //   dispatch(fetchingActors())
      //   setTimeout(() => resolve(data), 600)
      // })

      // request.then((result) => {
      //   let list = result.actors
      //   let actors
      //   // handle search
      //   if (search) {
      //     const regex = new RegExp(`^${search}|${search}`, 'gi')
      //     const fullname = (first, last) => first + ' ' + last
      //     list = list.filter((el) => {
      //       return regex.test(fullname(el.firstname, el.lastname))
      //     })
      //   }
      //   // handle sort
      //   if (criteria === 1) {
      //     const sortedActors = list.sort((a, b) => a.price - b.price)
      //     actors = [...sortedActors]
      //   } else {
      //     const sortedActors = list.sort((a, b) => {
      //       return (
      //         new Date(b.careerStart).getTime() -
      //         new Date(a.careerStart).getTime()
      //       )
      //     })
      //     actors = [...sortedActors]
      //   }

      //   // stock data
      //   dispatch(fetchedActors(actors))
      //   // setActors(actors);
      //   // setLoading(false);
      //   return result
      // })
    }
    fetchData()
  }, [criteria, search])

  useEffect(() => {
    if (!session) {
      router.push('/login')
    }
  }, [])

  return session && data ? (
    <div className="h-full">
      <Head>
        <title>YouMeet</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/logo-favicon.png" />
      </Head>
      <Header />
      <div
        className="w-full flex justify-center mt-16"
        style={{ background: 'linear-gradient(rgba(0,0,0,0.1),#FFF)' }}
      >
        <MapboxMap
          center={[3, 33]}
          zoom={1.5}
          employees={data.employees}
          styles={{
            width: '80%',
            minHeight: '800px',
            margin: 20,
            borderRadius: 20,
            border: '1px solid black',
          }}
        />
      </div>
      <div className="h-[80px] flex justify-center items-center">
        <Search
          search={search}
          handleChangeSearch={handleChangeSearch}
          criteria={criteria}
          handleChangeCriteria={handleChangeCriteria}
        />
      </div>
      <EmployeesList data={data} />
      <Footer />
    </div>
  ) : (
    <div className="w-full h-full flex justify-center items-center">
      <ClipLoader size={66} />
    </div>
  )
}

export default Home
// export default withProtected(Home);
